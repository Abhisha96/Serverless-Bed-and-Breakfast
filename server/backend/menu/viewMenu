import json
import boto3
import firebase_admin
from firebase_admin import credentials, firestore

def get_firebase_credentials():
    client = boto3.client('secretsmanager')

    secret_name = 'babu'

    secret = client.get_secret_value(SecretId=secret_name)

    return json.loads(secret['SecretString'])

def lambda_handler(event, context):
    if not firebase_admin._apps:
        firebase_creds = get_firebase_credentials()
        cred = credentials.Certificate(firebase_creds)
        firebase_admin.initialize_app(cred)

    restaurant_id = event.get('restaurantId')
    category = event.get('category') 
    if not restaurant_id or not category:
        return {
            'statusCode': 400,
            'body': json.dumps({'message': 'Missing required fields'})
        }

    db = firestore.client()
    restaurant_ref = db.collection('restaurants').document(restaurant_id)
    menu_ref = restaurant_ref.collection('menu').document(category)

    menu_data = menu_ref.get().to_dict()
    if menu_data and 'menu_items' in menu_data:
        return {
            'statusCode': 200,
            'body': json.dumps(menu_data['menu_items'])
        }
    else:
        return {
            'statusCode': 404,
            'body': json.dumps({'message': 'Category or menu not found'})
        }
